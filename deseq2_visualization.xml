<?xml version="1.0"?>
<!--
# Copyright (C) 2017 INRA
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<tool name="FROGSTAT Deseq2 Visualization" id="FROGSSTAT_DESeq2_Visualization" version="3.2">
	<description>to extract and visualize differentially abundant OTUs</description>
    <requirements>
        <requirement type="package" version="3.2.0">frogs</requirement>
        <requirement type="package" version="3.6.1">r-base</requirement>
        <requirement type="package" version="1.30.0">bioconductor-phyloseq</requirement>
        <requirement type="package" version="1.26.0">bioconductor-deseq2</requirement>
        <requirement type="package" version="0.2.01">r-formattable</requirement>
        <requirement type="package" version="0.8.4">r-dplyr</requirement>
        <requirement type="package" version="2.9.2">pandoc</requirement>
    </requirements>
	<command interpreter="python2.7">deseq2_visualization.py --phyloseqData $phyloseq_data
                                                             --dds $deseq2_dds
                                                             --varExp $varExp
                                                             #if $type.varType=="1"
                                                                --mod1 $type.mod1
                                                                --mod2 $type.mod2
                                                             #end if
                                                             --padj $padj
                                                             --html $html
	</command>
    <inputs>
		<!-- Files -->
	    <param format="rdata" name="phyloseq_data" type="data" label="Phyloseq object (format rdata)" help="This is the result of FROGS Phyloseq Import Data, used in FROGSSTAT DESeq2 Preprocess tool" optional="false">
            <validator type="empty_field" message="This parameter is required." />
        </param>
        <param format="rdata" name="deseq2_dds" type="data" label="DESeq2 object (format rdata)" help="This is the result of FROGSSTAT DESeq2 Preprocess tool." optional="false">
            <validator type="empty_field" message="This parameter is required." />
        </param>                    
		<!-- Parameters -->
		<param name="varExp" type="text" label="Experimental variable" help="The factor suspected to have an effect on OTUs' abundances (one of the variables used in FROGS DESeq2 Preprocess tool). Ex : Treatment" optional="false" value="" size="20">
            <validator type="empty_field" message="This parameter is required." />
        </param>
		
		<conditional name="type">
			<param name="varType" type="select" label="Is your Variable quantitative or qualitative?" help="If qualitative, choose 2 conditions to compare." optional="false">
                <option value="0">quantitative</option>
                <option value="1">qualitative</option>
            </param>
		    <when value="0"></when>        
		    <when value="1">
                <param name="mod1" type="text" label="Condition 1" help="One condition of the experimental variable (e.g. with)." optional="false" value="" size="20">
                    <validator type="empty_field" message="This parameter is required." />
                </param>
                
                <param name="mod2" type="text" label="Condition 2" help="Another condition of the experimental variable (e.g. without)." optional="false" value="" size="20">
                    <validator type="empty_field" message="This parameter is required." />
                </param>
			</when>
		</conditional>
		<param name="padj" type="text" label="Adjusted p-value threshold" help="Threshold used for statistical significance of the differentially abundant OTUs analysis." optional="false" value="0.05" size="20">
            <validator type="empty_field" message="This parameter is required." />
        </param>        
	</inputs>
	<outputs>
		<data format="html" name="html" label="${tool.name}: report.nb.html" from_work_dir="report.nb.html"/>
	</outputs>
	<help>

.. image:: static/images/FROGS_logo.png 
   :height: 144
   :width: 110

.. class:: infomark page-header h2

What it does

Launch one Rmarkdown Script to visualize the DESeq2 results. 

.. class:: infomark page-header h2

Inputs/Outputs

.. class:: h3

Input

**phyloseq object** (format rdata):
One phyloseq object stored in a rdata file.
This file is the result of FROGSSTAT Phyloseq Import Data.

**dds object** (format rdata):
A DESeq2 dataset (dds) stored in rdata file.
This file is the result of FROGSSTAT DESeq2 preprocess.

.. class:: h3

Ouput

**html file** (format `HTML &lt;https://en.wikipedia.org/wiki/HTML&gt;`_): visualization of "Differential Abundance".

The html file contains Table, Pie Chart, MA plot, Volcano plot and Heatmap plot. If the experimental variable is qualitative, only samples corresponding to the 2 compared conditions are shown in the Heatmap. Otherwise, samples are sorted in increasing order of the experimental variable. 

Table containing the differentially abundant OTUs.

 .. image:: static/images/FROGS_DESeq2_html_table.png 
     :height: 354
     :width: 1153

Pie Chart, MA plot and Volcano plot

 .. image:: static/images/FROGS_DESeq2_html_pieChart.png 
     :height: 391
     :width: 563

 .. image:: static/images/FROGS_DESeq2_html_MA_plot.png 
     :height: 324
     :width: 525

 .. image:: static/images/FROGS_DESeq2_html_Volcano_plot.png
     :height: 576
     :width: 720

Heatmap plot corresponding to the differentially abundant OTUs.

 .. image:: static/images/FROGS_DESeq2_html_heatmap_plot.png 
     :height: 576
     :width: 720

.. class:: infomark page-header h2

How it works

Based on the variable you precise to construct the model in FROGSSTAT DESeq2 Preprocess, this tool will construct table and graphs to visualize diff√©rentially abundant OTU between condition of the selected variables.

You may first precise the variable used to construct the model during the FROGSSTAT DESeq Preprocess step. If you precised variable with a confounding factor (a second variale), you may choose between one of the variables, but remember that you will see the result of this variable corrected by the confounding factor (and reversely) not just the selected variable itself.

If the variable is qualitative (ex: variable Treatment is define by two conditions : treatment1, treatment2, control), you must specify 2 conditions to compare (e.g. treatment1 vs treatment2 or treatment1 vs control, ...). 

**Contact**

Contacts: frogs-support@inrae.fr

Repositories: https://github.com/geraldinepascal/FROGS, https://github.com/geraldinepascal/FROGS-wrappers

Website: http://frogs.toulouse.inrae.fr/

Please cite the **FROGS article**: `Escudie F., et al. Bioinformatics, 2018. FROGS: Find, Rapidly, OTUs with Galaxy Solution. &lt;https://doi.org/10.1093/bioinformatics/btx791&gt;`_
	
	</help>
</tool>
